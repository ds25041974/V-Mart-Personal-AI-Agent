#!/usr/bin/env python3
"""
Comprehensive QA Testing for File Upload & AI Analysis Integration
Tests: File upload, content extraction, AI file-only reference
Run with: python run_file_upload_qa.py
"""

import os
import time
from datetime import datetime

import requests

# Configuration
BASE_URL = "http://localhost:8000"
AI_CHAT_URL = f"{BASE_URL}/ai-chat"
UPLOAD_URL = f"{AI_CHAT_URL}/upload"
ASK_URL = f"{BASE_URL}/ask"
LOGIN_URL = f"{AI_CHAT_URL}/login"

# Test files
TEST_PDF = "/tmp/vmart_store_performance_report.pdf"
TEST_CSV = "/tmp/vmart_sales_data.csv"

# Create a session to maintain cookies
session = requests.Session()


def login():
    """Login to get session"""
    try:
        # Try anonymous login
        response = session.post(LOGIN_URL, json={"email": ""}, timeout=5)
        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                print_info("‚úì Logged in (anonymous)")
                return True

        # Try with a test email
        response = session.post(
            LOGIN_URL, json={"email": "qa_test@vmart.com"}, timeout=5
        )
        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                print_info("‚úì Logged in (test email)")
                return True

        print_failure("Failed to login")
        return False
    except Exception as e:
        print_failure(f"Login error: {e}")
        return False


def print_test_header(test_num, title):
    print(f"\n{'=' * 80}")
    print(f"TEST {test_num}: {title}")
    print(f"{'=' * 80}")


def print_success(message):
    print(f"  ‚úÖ {message}")


def print_failure(message):
    print(f"  ‚ùå {message}")


def print_info(message):
    print(f"  ‚ÑπÔ∏è  {message}")


def test_server_running():
    """Test 1: Verify server is running"""
    print_test_header(1, "Server Availability & Authentication")

    try:
        response = session.get(AI_CHAT_URL, timeout=5)
        if response.status_code == 200:
            print_success("Server is running on http://localhost:8000")
            print_info(f"Response time: {response.elapsed.total_seconds():.2f}s")

            # Now login
            if login():
                print_success("Authentication successful")
                return True
            else:
                print_failure("Authentication failed")
                return False
        else:
            print_failure(f"Server returned status code: {response.status_code}")
            return False
    except Exception as e:
        print_failure(f"Server is not accessible: {e}")
        return False


def test_pdf_upload():
    """Test 2: PDF file upload"""
    print_test_header(2, "PDF File Upload")

    if not os.path.exists(TEST_PDF):
        print_failure(f"Test PDF not found: {TEST_PDF}")
        return False

    try:
        with open(TEST_PDF, "rb") as f:
            files = {"files": (os.path.basename(TEST_PDF), f, "application/pdf")}
            response = requests.post(UPLOAD_URL, files=files, timeout=10)

        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                file_info = data["files"][0]
                print_success(f"PDF uploaded: {file_info['filename']}")
                print_info(f"File type: {file_info['file_type']}")
                print_info(f"File size: {file_info['size']} bytes")
                print_info(
                    f"Content extracted: {len(file_info.get('content', ''))} chars"
                )

                metadata = file_info.get("metadata", {})
                if metadata:
                    print_info(f"Metadata: {metadata}")

                # Verify content extraction
                content = file_info.get("content", "")
                if len(content) > 100:
                    print_success("Content extraction successful")

                    # Check for key data points
                    has_stores = "VM_DL_001" in content or "VM_MH_001" in content
                    has_revenue = "‚Çπ" in content or "Lakh" in content

                    if has_stores:
                        print_success("Store IDs found in extracted content")
                    if has_revenue:
                        print_success("Revenue data found in extracted content")

                    return True
                else:
                    print_failure("Content extraction returned minimal data")
                    return False
            else:
                print_failure(f"Upload failed: {data.get('error')}")
                return False
        else:
            print_failure(f"Upload request failed: {response.status_code}")
            return False
    except Exception as e:
        print_failure(f"Upload error: {e}")
        return False


def test_csv_upload():
    """Test 3: CSV file upload"""
    print_test_header(3, "CSV File Upload")

    if not os.path.exists(TEST_CSV):
        print_failure(f"Test CSV not found: {TEST_CSV}")
        return False

    try:
        with open(TEST_CSV, "rb") as f:
            files = {"files": (os.path.basename(TEST_CSV), f, "text/csv")}
            response = requests.post(UPLOAD_URL, files=files, timeout=10)

        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                file_info = data["files"][0]
                print_success(f"CSV uploaded: {file_info['filename']}")
                print_info(
                    f"Content extracted: {len(file_info.get('content', ''))} chars"
                )

                # Check for CSV data
                content = file_info.get("content", "")
                if "Store_ID" in content or "Revenue" in content:
                    print_success("CSV headers found in content")
                    return True
                else:
                    print_failure("CSV content not properly extracted")
                    return False
            else:
                print_failure(f"Upload failed: {data.get('error')}")
                return False
        else:
            print_failure(f"Upload request failed: {response.status_code}")
            return False
    except Exception as e:
        print_failure(f"Upload error: {e}")
        return False


def test_ai_with_file_context():
    """Test 4: AI analysis with file context"""
    print_test_header(4, "AI Analysis with Uploaded File")

    # First upload the PDF
    print_info("Uploading PDF for AI analysis...")

    try:
        with open(TEST_PDF, "rb") as f:
            files = {"files": (os.path.basename(TEST_PDF), f, "application/pdf")}
            upload_response = requests.post(UPLOAD_URL, files=files, timeout=10)

        if not upload_response.json().get("success"):
            print_failure("Failed to upload PDF for AI test")
            return False

        file_info = upload_response.json()["files"][0]
        print_success("PDF uploaded for AI analysis")

        # Now test AI with file context
        print_info("Testing AI response with file context...")

        file_context = [
            {
                "filename": file_info["filename"],
                "type": file_info["file_type"],
                "content": file_info["content"],
                "metadata": file_info.get("metadata", {}),
            }
        ]

        test_questions = [
            {
                "question": "What stores are mentioned in the uploaded report?",
                "expected_keywords": [
                    "VM_DL_001",
                    "VM_MH_001",
                    "VM_KA_001",
                    "Delhi",
                    "Mumbai",
                    "Bangalore",
                ],
                "description": "Store identification from file",
            },
            {
                "question": "What is the revenue for Mumbai store?",
                "expected_keywords": ["67.8", "Lakh", "Mumbai"],
                "description": "Revenue data from file",
            },
            {
                "question": "Which store has the highest revenue?",
                "expected_keywords": ["Mumbai", "VM_MH_001", "67.8"],
                "description": "Comparative analysis from file",
            },
        ]

        passed = 0
        failed = 0

        for idx, test in enumerate(test_questions, 1):
            print(f"\n  Question {idx}: {test['question']}")

            payload = {
                "prompt": test["question"],
                "use_context": True,
                "file_context": file_context,
            }

            try:
                ai_response = requests.post(ASK_URL, json=payload, timeout=30)

                if ai_response.status_code == 200:
                    response_data = ai_response.json()
                    ai_answer = response_data.get("response", "")

                    # Check if response contains expected keywords
                    keywords_found = sum(
                        1 for kw in test["expected_keywords"] if kw in ai_answer
                    )

                    if keywords_found > 0:
                        print_success(
                            f"{test['description']}: {keywords_found}/{len(test['expected_keywords'])} keywords found"
                        )
                        print_info(f"Response preview: {ai_answer[:200]}...")
                        passed += 1
                    else:
                        print_failure(
                            f"{test['description']}: No expected keywords found"
                        )
                        print_info(f"Response: {ai_answer[:200]}...")
                        failed += 1
                else:
                    print_failure(f"AI request failed: {ai_response.status_code}")
                    failed += 1

            except Exception as e:
                print_failure(f"AI request error: {e}")
                failed += 1

            time.sleep(1)  # Rate limiting

        print(f"\n  AI Analysis Results: {passed} passed, {failed} failed")
        return passed > failed

    except Exception as e:
        print_failure(f"AI test error: {e}")
        return False


def test_file_only_reference():
    """Test 5: AI should NOT use data outside uploaded file"""
    print_test_header(5, "File-Only Reference (No External Data)")

    try:
        # Upload the PDF
        with open(TEST_PDF, "rb") as f:
            files = {"files": (os.path.basename(TEST_PDF), f, "application/pdf")}
            upload_response = requests.post(UPLOAD_URL, files=files, timeout=10)

        file_info = upload_response.json()["files"][0]

        file_context = [
            {
                "filename": file_info["filename"],
                "type": file_info["file_type"],
                "content": file_info["content"],
                "metadata": file_info.get("metadata", {}),
            }
        ]

        # Test questions about data NOT in the file
        negative_tests = [
            {
                "question": "What is the revenue for Pune store?",
                "should_not_contain": ["Pune store revenue is", "Pune generates", "‚Çπ"],
                "should_contain": [
                    "not available",
                    "not in",
                    "not mentioned",
                    "uploaded file",
                ],
                "description": "Store not in file",
            },
            {
                "question": "Tell me about V-Mart store in Chennai",
                "should_not_contain": ["Chennai store", "Chennai location"],
                "should_contain": [
                    "not available",
                    "not in",
                    "only covers",
                    "Delhi, Mumbai, Bangalore",
                ],
                "description": "Store not in file",
            },
        ]

        passed = 0
        failed = 0

        for idx, test in enumerate(negative_tests, 1):
            print(f"\n  Negative Test {idx}: {test['question']}")

            payload = {
                "prompt": test["question"],
                "use_context": True,
                "file_context": file_context,
            }

            try:
                ai_response = requests.post(ASK_URL, json=payload, timeout=30)

                if ai_response.status_code == 200:
                    ai_answer = ai_response.json().get("response", "").lower()

                    # Check that AI doesn't make up data
                    made_up_data = any(
                        phrase.lower() in ai_answer
                        for phrase in test["should_not_contain"]
                    )

                    # Check that AI correctly states data is unavailable
                    correct_response = any(
                        phrase.lower() in ai_answer for phrase in test["should_contain"]
                    )

                    if correct_response and not made_up_data:
                        print_success(
                            f"{test['description']}: Correctly stated data unavailable"
                        )
                        passed += 1
                    elif made_up_data:
                        print_failure(
                            f"{test['description']}: AI made up data not in file!"
                        )
                        print_info(f"Response: {ai_answer[:200]}...")
                        failed += 1
                    else:
                        print_failure(
                            f"{test['description']}: AI didn't clearly state unavailability"
                        )
                        print_info(f"Response: {ai_answer[:200]}...")
                        failed += 1
                else:
                    print_failure(f"AI request failed: {ai_response.status_code}")
                    failed += 1

            except Exception as e:
                print_failure(f"Request error: {e}")
                failed += 1

            time.sleep(1)  # Rate limiting

        print(f"\n  File-Only Reference Results: {passed} passed, {failed} failed")
        return passed == len(negative_tests)

    except Exception as e:
        print_failure(f"File-only reference test error: {e}")
        return False


def test_multiple_file_upload():
    """Test 6: Multiple files upload"""
    print_test_header(6, "Multiple Files Upload")

    if not os.path.exists(TEST_PDF) or not os.path.exists(TEST_CSV):
        print_failure("Test files not found")
        return False

    try:
        # Upload both files
        files = [
            (
                "files",
                (os.path.basename(TEST_PDF), open(TEST_PDF, "rb"), "application/pdf"),
            ),
            ("files", (os.path.basename(TEST_CSV), open(TEST_CSV, "rb"), "text/csv")),
        ]

        response = requests.post(UPLOAD_URL, files=files, timeout=10)

        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                uploaded_files = data["files"]
                print_success(f"Multiple files uploaded: {len(uploaded_files)} files")

                for file_info in uploaded_files:
                    print_info(
                        f"  ‚Ä¢ {file_info['filename']} ({file_info['file_type']})"
                    )

                # Check both files have content
                all_have_content = all(
                    len(f.get("content", "")) > 100 for f in uploaded_files
                )

                if all_have_content:
                    print_success("All files have extracted content")
                    return True
                else:
                    print_failure("Some files missing content")
                    return False
            else:
                print_failure(f"Upload failed: {data.get('error')}")
                return False
        else:
            print_failure(f"Upload request failed: {response.status_code}")
            return False
    except Exception as e:
        print_failure(f"Multiple upload error: {e}")
        return False


def test_greeting_handling():
    """Test 7: Simple greetings should not trigger file analysis"""
    print_test_header(7, "Greeting Handling (Should Skip File Analysis)")

    greetings = ["hi", "hello", "hey", "good morning", "thanks"]

    passed = 0
    failed = 0

    for greeting in greetings:
        payload = {"prompt": greeting, "use_context": True}

        try:
            response = requests.post(ASK_URL, json=payload, timeout=10)

            if response.status_code == 200:
                ai_answer = response.json().get("response", "")

                # Greeting responses should be short and friendly
                if len(ai_answer) < 500:  # Reasonable length for greeting
                    print_success(
                        f"'{greeting}': Short response ({len(ai_answer)} chars)"
                    )
                    passed += 1
                else:
                    print_failure(f"'{greeting}': Too long ({len(ai_answer)} chars)")
                    failed += 1
            else:
                print_failure(f"'{greeting}': Request failed")
                failed += 1

        except Exception as e:
            print_failure(f"'{greeting}': Error - {e}")
            failed += 1

        time.sleep(0.5)

    print(f"\n  Greeting Results: {passed} passed, {failed} failed")
    return passed > failed


def main():
    print("\n" + "=" * 80)
    print("FILE UPLOAD & AI ANALYSIS - COMPREHENSIVE QA TESTS")
    print("=" * 80)
    print(f"Test Started: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Server: {BASE_URL}")
    print("=" * 80)

    results = {}

    # Run all tests
    results["Server Running"] = test_server_running()

    if results["Server Running"]:
        results["PDF Upload"] = test_pdf_upload()
        results["CSV Upload"] = test_csv_upload()
        results["AI with File Context"] = test_ai_with_file_context()
        results["File-Only Reference"] = test_file_only_reference()
        results["Multiple File Upload"] = test_multiple_file_upload()
        results["Greeting Handling"] = test_greeting_handling()
    else:
        print("\n‚ùå Server not running - skipping remaining tests")
        print("   Start server with: python main.py")

    # Print summary
    print("\n" + "=" * 80)
    print("QA TEST SUMMARY")
    print("=" * 80)

    passed = sum(1 for v in results.values() if v)
    total = len(results)

    for test_name, result in results.items():
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status:12} - {test_name}")

    print("\n" + "=" * 80)
    print(f"TOTAL: {passed}/{total} tests passed ({passed / total * 100:.1f}%)")
    print("=" * 80)

    if passed == total:
        print("\nüéâ ALL TESTS PASSED!")
        return 0
    else:
        print(f"\n‚ö†Ô∏è  {total - passed} test(s) failed")
        return 1


if __name__ == "__main__":
    exit(main())
